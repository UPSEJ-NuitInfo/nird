<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Moodle Glitch Defender</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        body {
            margin: 0;
            background-color: #000;
            color: #0ff;
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
            cursor: crosshair;
            user-select: none;
        }

        /* L'IMAGE DE FOND (MOODLE) */
        #game-background {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('moodle.png'); /* TON IMAGE ICI */
            background-size: cover;
            background-position: center;
            z-index: 0;
            transition: filter 0.2s, transform 0.1s;
        }

        /* Effet de tremblement quand touché */
        .shake-bg { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        canvas {
            position: absolute; top: 0; left: 0; z-index: 10; display: block;
        }

        /* UI */
        #ui {
            position: absolute; top: 20px; left: 20px; z-index: 20;
            text-shadow: 0 0 10px #0ff; pointer-events: none;
        }
        .hud-text { font-size: 24px; margin-bottom: 5px; }
        .danger-text { color: red; text-shadow: 0 0 10px red; animation: blink 0.2s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* VISEUR */
        #cursor-sight {
            position: absolute; width: 40px; height: 40px;
            border: 2px solid #ff0055; border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 30;
            box-shadow: 0 0 15px #ff0055; transition: transform 0.1s;
        }

        /* ÉCRANS */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100;
        }
        
        h1 { font-size: 60px; color: #0ff; text-shadow: 0 0 20px #0ff; margin-bottom: 10px; }
        p { font-size: 20px; color: #fff; text-align: center; }
        
        .btn-container { display: flex; gap: 20px; margin-top: 30px; }

        button {
            padding: 15px 40px; font-size: 20px;
            background: transparent; color: #0ff;
            border: 2px solid #0ff; font-family: 'Orbitron', sans-serif;
            cursor: pointer; box-shadow: 0 0 15px #0ff; transition: all 0.2s;
        }
        button:hover { background: #0ff; color: #000; box-shadow: 0 0 30px #0ff; }
        button.secondary { border-color: #aaa; color: #aaa; box-shadow: none; }
        button.secondary:hover { background: #aaa; color: #000; }

    </style>
</head>
<body>

    <div id="game-background"></div>
    <div id="cursor-sight"></div>
    <canvas id="gameCanvas"></canvas>

    <div id="ui" style="display: none;">
        <div class="hud-text">SCORE: <span id="score">0</span></div>
        <div class="hud-text">ÉTAT DU SERVEUR: <span id="health">100</span>%</div>
    </div>

    <div id="start-screen" class="screen">
        <h1>MOODLE DEFENDER</h1>
        <p>Protégez la page avant qu'elle ne crash totalement !<br>
        Tirez sur les bugs rouges. Évitez leurs tirs.</p>
        <button onclick="startGame()">LANCER LA SESSION</button>
    </div>

    <div id="end-screen" class="screen" style="display: none;">
        <h1 style="color: #ff0055;">ERREUR 500</h1>
        <p>Le serveur a explosé.</p>
        <p>Score Final : <span id="final-score">0</span></p>
        
        <div class="btn-container">
            <button onclick="startGame()">REJOUER</button>
            <button class="secondary" onclick="showMenu()">RETOUR MENU</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const bg = document.getElementById('game-background');
        const sight = document.getElementById('cursor-sight');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let gameRunning = false;
        let score = 0;
        let health = 100;
        
        let mouseX = canvas.width / 2;
        let mouseY = canvas.height / 2;

        let lasers = [];
        let enemies = [];
        let enemyLasers = [];
        let particles = [];

        // --- GESTION SOURIS ---
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            sight.style.left = mouseX + 'px';
            sight.style.top = mouseY + 'px';
        });

        document.addEventListener('mousedown', () => {
            if (!gameRunning) return;
            shootLaser();
            sight.style.transform = "translate(-50%, -50%) scale(0.8)";
            setTimeout(() => sight.style.transform = "translate(-50%, -50%) scale(1)", 50);
        });

        // --- MOTEUR VISUEL DU "CRASH" ---
        function updateBackgroundDamage() {
            // Plus la santé baisse, plus l'image est détruite
            const damage = 100 - health;
            
            // Calcul des filtres
            const blur = damage / 20; // Flou progressif
            const contrast = 100 + (damage * 2); // Contraste violent
            const hue = damage * 1.5; // Couleurs qui tournent (glitch)
            const invert = damage > 80 ? 100 : 0; // Inversion totale à la fin

            bg.style.filter = `blur(${blur}px) contrast(${contrast}%) hue-rotate(${hue}deg) invert(${invert}%)`;
            
            // Effet secousse
            bg.classList.add('shake-bg');
            setTimeout(() => bg.classList.remove('shake-bg'), 500);
        }

        // --- CLASSES ---
        class Laser {
            constructor(x, y) {
                this.x = x; this.y = y;
            }
            draw() {
                ctx.beginPath();
                ctx.moveTo(0, canvas.height); // Tir depuis le bas gauche
                ctx.lineTo(this.x, this.y);
                ctx.strokeStyle = '#00ffaa';
                ctx.lineWidth = 2;
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#00ffaa';
                ctx.stroke();
                ctx.shadowBlur = 0;
                createExplosion(this.x, this.y, '#00ffaa', 5);
            }
        }

        class Enemy {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * (canvas.height - 100) + 50;
                this.radius = 30;
                this.hp = 2;
                this.vx = (Math.random() - 0.5) * 6;
                this.vy = (Math.random() - 0.5) * 6;
                this.shootTimer = Math.random() * 100;
                this.text = ["BUG", "LAG", "404"][Math.floor(Math.random()*3)];
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                if(this.x < 0 || this.x > canvas.width) this.vx *= -1;
                if(this.y < 0 || this.y > canvas.height) this.vy *= -1;

                this.shootTimer--;
                if(this.shootTimer <= 0) {
                    enemyLasers.push(new EnemyProjectile(this.x, this.y, mouseX, mouseY));
                    this.shootTimer = 80 + Math.random() * 100;
                }
            }
            draw() {
                ctx.font = "bold 20px Orbitron";
                ctx.fillStyle = "#ff0055";
                ctx.fillText(this.text, this.x - 20, this.y);
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.strokeStyle = "#ff0055";
                ctx.stroke();
            }
        }

        class EnemyProjectile {
            constructor(x, y, tx, ty) {
                this.x = x; this.y = y;
                const angle = Math.atan2(ty - y, tx - x);
                this.vx = Math.cos(angle) * 8;
                this.vy = Math.sin(angle) * 8;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                const dist = Math.hypot(this.x - mouseX, this.y - mouseY);
                if (dist < 25) { takeDamage(); return true; } // Touche joueur
                if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) return true;
                return false;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, 6, 0, Math.PI * 2);
                ctx.fillStyle = "#fff";
                ctx.fill();
                ctx.shadowBlur = 10; ctx.shadowColor = "red"; ctx.stroke(); ctx.shadowBlur = 0;
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.vx = (Math.random() - 0.5) * 10; this.vy = (Math.random() - 0.5) * 10;
                this.life = 1.0;
            }
            update() { this.x += this.vx; this.y += this.vy; this.life -= 0.05; }
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, 4, 4);
                ctx.globalAlpha = 1.0;
            }
        }

        // --- LOGIQUE JEU ---

        function startGame() {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('ui').style.display = 'block';
            
            // Reset complet
            bg.style.filter = "none";
            gameRunning = true;
            score = 0;
            health = 100;
            document.getElementById('health').innerText = "100";
            document.getElementById('health').parentElement.classList.remove('danger-text');
            
            enemies = [];
            enemyLasers = [];
            particles = [];
            lasers = [];
            
            spawnEnemy();
            loop();
        }

        function showMenu() {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('ui').style.display = 'none';
            // Reset background clean
            bg.style.filter = "none";
        }

        function shootLaser() {
            lasers.push(new Laser(mouseX, mouseY));
            enemies.forEach((enemy, index) => {
                const dist = Math.hypot(enemy.x - mouseX, enemy.y - mouseY);
                if (dist < enemy.radius + 10) {
                    enemy.hp--;
                    createExplosion(enemy.x, enemy.y, '#ff0055', 5);
                    if(enemy.hp <= 0) {
                        enemies.splice(index, 1);
                        score += 100;
                        document.getElementById('score').innerText = score;
                        createExplosion(enemy.x, enemy.y, '#fff', 15);
                    }
                }
            });
        }

        function takeDamage() {
            health -= 10;
            document.getElementById('health').innerText = health;
            
            // Appliquer l'effet de destruction sur l'image
            updateBackgroundDamage();

            if(health <= 30) document.getElementById('health').parentElement.classList.add('danger-text');

            if (health <= 0) endGame();
        }

        function createExplosion(x, y, color, count) {
            for(let i=0; i<count; i++) particles.push(new Particle(x, y, color));
        }

        function spawnEnemy() {
            if(!gameRunning) return;
            if(enemies.length < 4 + (score/1000)) enemies.push(new Enemy());
            setTimeout(spawnEnemy, 1500);
        }

        function loop() {
            if (!gameRunning) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            enemies.forEach(e => { e.update(); e.draw(); });
            
            for (let i = enemyLasers.length - 1; i >= 0; i--) {
                let p = enemyLasers[i];
                if(p.update()) enemyLasers.splice(i, 1);
                else p.draw();
            }

            for (let i = lasers.length - 1; i >= 0; i--) {
                lasers[i].draw();
                lasers.splice(i, 1); 
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw();
                if(particles[i].life <= 0) particles.splice(i, 1);
            }

            requestAnimationFrame(loop);
        }

        function endGame() {
            gameRunning = false;
            document.getElementById('end-screen').style.display = 'flex';
            document.getElementById('ui').style.display = 'none';
            document.getElementById('final-score').innerText = score;
        }

    </script>
</body>
</html>