<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Tech Ninja : GAFAM Slicer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background: #222;
            font-family: 'Permanent Marker', cursive;
            user-select: none;
            cursor: crosshair; /* Curseur de vis√©e */
        }

        /* Interface (Score & Vies) */
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #fff;
            pointer-events: none; /* Laisse passer les clics */
            z-index: 10;
        }

        #score { font-size: 40px; color: #FFD700; text-shadow: 2px 2px #000; }
        #lives { font-size: 30px; color: #ff4444; margin-top: 5px; }

        /* √âcran de fin */
        #game-over {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 20;
        }

        h1 { font-size: 60px; margin: 0; color: #ff4444; text-shadow: 4px 4px #000; }
        p { font-size: 24px; }

        button {
            padding: 15px 30px;
            font-size: 24px;
            font-family: 'Permanent Marker', cursive;
            background: #FFD700;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 0 #b39700;
            transform: rotate(-2deg);
            transition: transform 0.1s;
        }
        button:hover { transform: rotate(2deg) scale(1.1); background: #fff; }

        canvas { display: block; }
    </style>
</head>
<body>

    <div id="ui">
        <div id="score">0</div>
        <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <div id="game-over">
        <h1>GAME OVER</h1>
        <p>Score final : <span id="final-score">0</span></p>
        <div style="display:flex;gap:10px;justify-content:center;">
            <button onclick="startGame()">REJOUER</button>
            <button onclick="sendScoreAndClose()">Retour √† la map</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Adaptation √©cran
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // --- CONFIGURATION ---
        let gameRunning = false;
        let score = 0;
        let lives = 3;
        let difficulty = 1;

        // Les cibles (Images)
        const GAFAM = [
            "logo/google.webp",
            "logo/apple.png",
            "logo/facebook.webp",
            "logo/Amazon.png",
            "logo/microsoft.png"
        ];

        // Listes d'objets
        let entities = [];   // Cibles actives
        let particles = [];  // Effets d'explosion
        let bladePath = [];  // Tra√Æn√©e de la souris

        // Souris
        let mouseX = 0, mouseY = 0;
        let isMouseDown = false;

        // --- CLASSES ---

        class Entity {
            constructor() {
                this.radius = 40;
                this.x = Math.random() * (canvas.width - 100) + 50;
                this.y = canvas.height + this.radius;
                
                // Physique de lancer
                this.vx = (Math.random() - 0.5) * 4; 
                this.vy = -(Math.random() * 5 + 12 + difficulty); 
                this.gravity = 0.25;
                this.rotation = 0;
                this.rotSpeed = (Math.random() - 0.5) * 0.2;

                // 15% de chance d'√™tre un VIRUS (Bombe)
                this.isBomb = Math.random() < 0.15;

                if (this.isBomb) {
                    this.type = "text";
                    this.content = "ü¶†";
                    this.color = "#00FF00"; // Vert pour l'explosion virus
                } else {
                    this.type = "image";
                    this.img = new Image();
                    this.img.src = GAFAM[Math.floor(Math.random() * GAFAM.length)];
                    this.color = "#FFD700"; // Or pour l'explosion GAFAM
                }
                
                this.active = true;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += this.gravity;
                this.rotation += this.rotSpeed;

                // Si sort par le bas sans √™tre touch√©
                if (this.y > canvas.height + 50) {
                    this.active = false;
                    if (!this.isBomb && gameRunning) {
                        loseLife();
                    }
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                
                // Fond du cercle
                ctx.beginPath();
                ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.isBomb ? "#222" : "#FFF";
                ctx.fill();
                ctx.lineWidth = 3;
                ctx.strokeStyle = this.isBomb ? "#00FF00" : "#444";
                ctx.stroke();

                if (this.type === "text") {
                    // Dessin Bombe
                    ctx.font = "40px Arial";
                    ctx.fillStyle = this.color;
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(this.content, 0, 5);
                } else {
                    // Dessin Logo
                    try {
                        ctx.drawImage(this.img, -25, -25, 50, 50);
                    } catch (e) {
                        // Image pas charg√©e
                    }
                }
                
                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.vx = (Math.random() - 0.5) * 10;
                this.vy = (Math.random() - 0.5) * 10;
                this.life = 1.0; 
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= 0.02; 
            }
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, Math.random() * 5 + 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }

        // --- GESTION DU JEU ---

        function startGame() {
            gameRunning = true;
            score = 0;
            lives = 3;
            difficulty = 1;
            entities = [];
            particles = [];
            document.getElementById('game-over').style.display = 'none';
            updateUI();
            loop();
            spawnLoop();
        }

        function spawnLoop() {
            if (!gameRunning) return;
            
            // Cr√©e 1 ou 2 entit√©s
            entities.push(new Entity());
            if (Math.random() > 0.7 && score > 10) entities.push(new Entity());

            // Acc√©l√©ration du jeu
            let nextSpawn = 1000 - (score * 5); 
            if (nextSpawn < 400) nextSpawn = 400;

            setTimeout(spawnLoop, nextSpawn);
        }

        function loseLife() {
            lives--;
            updateUI();
            
            // Flash rouge √©cran
            document.body.style.backgroundColor = "#500";
            setTimeout(() => document.body.style.backgroundColor = "#222", 100);

            if (lives <= 0) endGame();
        }

        function endGame() {
            gameRunning = false;
            document.getElementById('final-score').innerText = score;
            document.getElementById('game-over').style.display = 'block';
        }

        function updateUI() {
            document.getElementById('score').innerText = score;
            let heartString = "";
            for(let i=0; i<lives; i++) heartString += "‚ù§Ô∏è";
            document.getElementById('lives').innerText = heartString;
        }

        function createExplosion(x, y, color) {
            for (let i = 0; i < 15; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        // --- BOUCLE PRINCIPALE ---

        function loop() {
            if (!gameRunning) return;

            // 1. Fond avec effet de tra√Æn√©e
            ctx.fillStyle = 'rgba(34, 34, 34, 0.4)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. Gestion Lame (Blade)
            if (bladePath.length > 1) {
                ctx.beginPath();
                ctx.moveTo(bladePath[0].x, bladePath[0].y);
                for (let i = 1; i < bladePath.length; i++) {
                    ctx.lineTo(bladePath[i].x, bladePath[i].y);
                }
                ctx.strokeStyle = "#00FFFF";
                ctx.lineWidth = 5;
                ctx.lineCap = "round";
                ctx.lineJoin = "round";
                ctx.shadowBlur = 10;
                ctx.shadowColor = "#00FFFF";
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
            if (bladePath.length > 10) bladePath.shift();
            if (!isMouseDown && bladePath.length > 0) bladePath.shift(); 

            // 3. Gestion Entit√©s
            for (let i = entities.length - 1; i >= 0; i--) {
                let e = entities[i];
                e.update();
                e.draw();

                // D√âTECTION COUPE
                let dx = mouseX - e.x;
                let dy = mouseY - e.y;
                let distance = Math.sqrt(dx*dx + dy*dy);

                if (distance < e.radius && isMouseDown) {
                    if (e.isBomb) {
                        createExplosion(e.x, e.y, "#00FF00");
                        endGame(); 
                    } else {
                        score += 10;
                        difficulty += 0.1;
                        createExplosion(e.x, e.y, e.color);
                        updateUI();
                        entities.splice(i, 1);
                    }
                } else if (!e.active) {
                    entities.splice(i, 1);
                }
            }

            // 4. Gestion Particules
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.update();
                p.draw();
                if (p.life <= 0) particles.splice(i, 1);
            }

            requestAnimationFrame(loop);
        }

        // --- ENTR√âES SOURIS / TOUCH ---

        function trackInput(x, y) {
            mouseX = x;
            mouseY = y;
            if (isMouseDown) {
                bladePath.push({x: x, y: y});
            }
        }

        window.addEventListener('mousedown', () => isMouseDown = true);
        window.addEventListener('mouseup', () => { isMouseDown = false; bladePath = []; });
        window.addEventListener('mousemove', e => trackInput(e.clientX, e.clientY));

        // Support Mobile
        window.addEventListener('touchstart', e => { 
            isMouseDown = true; 
            trackInput(e.touches[0].clientX, e.touches[0].clientY);
        });
        window.addEventListener('touchend', () => { isMouseDown = false; bladePath = []; });
        window.addEventListener('touchmove', e => {
            e.preventDefault();
            trackInput(e.touches[0].clientX, e.touches[0].clientY);
        });

        // Resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // D√©marrage initial
        startGame();

        function sendScoreAndClose() {
            try {
                const url = `/map?level=2&score=${encodeURIComponent(score)}`;
                window.location.href = url;
            } catch (e) {}
        }

        // Easter Egg
        let saisie = "";
        document.addEventListener('keydown', (e) => {
            saisie += e.key.toLowerCase();
            if (!"bouton".startsWith(saisie)) saisie = e.key.toLowerCase() === 'b' ? 'b' : '';
            if (saisie === "bouton") window.location.href = "boutonCssFou.html";
        });

    </script>
</body>
</html>