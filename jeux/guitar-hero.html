<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Duck Hero vs GAFAM</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap');

        body {
            margin: 0;
            background-color: #111;
            color: white;
            font-family: 'Black Ops One', cursive;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            user-select: none;
        }

        /* --- SCÃˆNE ET DÃ‰COR --- */
        #stage {
            position: absolute;
            top: 20px;
            text-align: center;
            z-index: 0;
        }
        #duck-avatar {
            font-size: 100px;
            display: inline-block;
            filter: drop-shadow(0 0 20px #FFD700);
        }
        .rocking { animation: headbang 0.4s infinite alternate ease-in-out; }
        
        @keyframes headbang {
            from { transform: rotate(-15deg) translateY(0); }
            to { transform: rotate(15deg) translateY(20px); }
        }

        /* --- INTERFACE (HUD) --- */
        #ui {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            z-index: 10;
        }
        #score { font-size: 50px; color: #FFD700; text-shadow: 0 0 10px #FFD700; }
        #combo { font-size: 25px; color: #00e5ff; }
        #multiplier { font-size: 35px; color: #ff0055; margin-top: 5px; }

        /* --- LE MANCHE DE GUITARE (3D) --- */
        #fretboard-container {
            perspective: 600px;
            margin-top: 100px;
        }

        #fretboard {
            width: 500px; /* Plus large pour bien voir */
            height: 600px;
            background: linear-gradient(to bottom, #1a1a1a 0%, #000 100%);
            transform: rotateX(50deg);
            border-left: 5px solid #444;
            border-right: 5px solid #444;
            display: flex;
            justify-content: space-around;
            overflow: hidden;
            position: relative;
            box-shadow: 0 50px 50px rgba(0,0,0,0.8);
        }

        /* Pistes */
        .track {
            width: 25%;
            height: 100%;
            border-right: 2px solid #333;
            position: relative;
        }
        .track:last-child { border: none; }

        /* --- ZONE DE FRAPPE & TOUCHES --- */
        .hit-zone {
            position: absolute;
            bottom: 20px;
            width: 90%;
            height: 60px;
            left: 5%;
            border-radius: 10px;
            border: 4px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.05s, background-color 0.05s, border-color 0.05s;
        }

        /* Lettres des touches (D F J K) */
        .key-label {
            font-size: 30px;
            color: rgba(255,255,255,0.5);
            pointer-events: none;
        }

        /* Couleurs par piste */
        #track-0 .hit-zone { border-color: #00ff00; } /* D - Vert */
        #track-1 .hit-zone { border-color: #ff0000; } /* F - Rouge */
        #track-2 .hit-zone { border-color: #ffff00; } /* J - Jaune */
        #track-3 .hit-zone { border-color: #0000ff; } /* K - Bleu */

        /* Effet quand on appuie */
        .pressed { 
            transform: scale(0.95); 
            background-color: rgba(255,255,255,0.8) !important;
            border-color: white !important;
        }
        .pressed .key-label { color: black; }

        /* --- NOTES (GAFAM) --- */
        .note {
            position: absolute;
            width: 70px;
            height: 70px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px; /* Taille des logos */
            border-radius: 50%;
            box-shadow: 0 0 20px currentColor;
            background: rgba(0,0,0,0.5);
            border: 2px solid white;
        }

        /* Couleurs des notes GAFAM */
        .note.google { color: #4285F4; box-shadow: 0 0 20px #4285F4; }
        .note.apple  { color: #A2AAAD; box-shadow: 0 0 20px #A2AAAD; }
        .note.meta   { color: #1877F2; box-shadow: 0 0 20px #1877F2; }
        .note.amazon { color: #FF9900; box-shadow: 0 0 20px #FF9900; }
        .note.micro  { color: #00A4EF; box-shadow: 0 0 20px #00A4EF; }

        /* --- FEEDBACK VISUEL --- */
        .feedback-text {
            position: absolute;
            font-size: 40px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px #FF0055;
            animation: floatText 0.5s forwards;
            pointer-events: none;
            z-index: 20;
        }

        @keyframes floatText {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        /* --- Ã‰CRAN DE DÃ‰MARRAGE --- */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .keys-info {
            display: flex;
            gap: 20px;
            margin: 30px 0;
        }
        .key-box {
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 24px;
            color: #FFD700;
        }

        button {
            padding: 20px 50px;
            font-size: 30px;
            background: #FF0055;
            color: white;
            border: none;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 0 0 30px #FF0055;
            transform: rotate(-2deg);
            transition: transform 0.1s;
        }
        button:hover { transform: rotate(2deg) scale(1.1); background: white; color: #FF0055; }

    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-size: 70px; color: #FFD700; margin: 0;">DUCK HERO</h1>
        <h2 style="color: white;">VS GAFAM INVASION</h2>
        
        <p style="color: #aaa; margin-top: 20px;">Place tes doigts sur :</p>
        <div class="keys-info">
            <div class="key-box" style="border-color: #00ff00;">D</div>
            <div class="key-box" style="border-color: #ff0000;">F</div>
            <div class="key-box" style="border-color: #ffff00;">J</div>
            <div class="key-box" style="border-color: #0000ff;">K</div>
        </div>

        <button onclick="startGame()">JOUER ! ðŸ¤˜</button>
    </div>

    <div id="ui">
        <div id="score">00000</div>
        <div id="combo">COMBO: 0</div>
        <div id="multiplier">x1</div>
    </div>

    <div id="stage">
        <div id="duck-avatar">ðŸ¦†ðŸŽ¸</div>
    </div>

    <div id="fretboard-container">
        <div id="fretboard">
            
            <div class="track" id="track-0">
                <div class="hit-zone">
                    <span class="key-label">D</span>
                </div>
            </div>
            
            <div class="track" id="track-1">
                <div class="hit-zone">
                    <span class="key-label">F</span>
                </div>
            </div>
            
            <div class="track" id="track-2">
                <div class="hit-zone">
                    <span class="key-label">J</span>
                </div>
            </div>
            
            <div class="track" id="track-3">
                <div class="hit-zone">
                    <span class="key-label">K</span>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Mapping Touches -> Pistes
        const KEYS = {
            'd': 0, 'D': 0,
            'f': 1, 'F': 1,
            'j': 2, 'J': 2,
            'k': 3, 'K': 3
        };

        // Logos GAFAM
        const GAFAM = [
            { char: "G", class: "google" },  // Google
            { char: "ðŸŽ", class: "apple" },  // Apple
            { char: "ðŸ“˜", class: "meta" },   // Facebook
            { char: "ðŸ“¦", class: "amazon" }, // Amazon
            { char: "ðŸªŸ", class: "micro" }   // Microsoft
        ];

        const tracks = [
            document.getElementById('track-0'),
            document.getElementById('track-1'),
            document.getElementById('track-2'),
            document.getElementById('track-3')
        ];

        // ParamÃ¨tres
        const NOTE_SPEED = 6;
        const SPAWN_RATE = 700; // ms
        const HIT_Y = 530; // Zone de frappe (ajustÃ© pour la perspective)
        const HIT_MARGIN = 60; // TolÃ©rance

        let notes = [];
        let score = 0;
        let combo = 0;
        let multiplier = 1;
        let isPlaying = false;
        let spawner;

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('duck-avatar').classList.add('rocking');
            isPlaying = true;
            gameLoop();
            spawner = setInterval(spawnNote, SPAWN_RATE);
        }

        function spawnNote() {
            if(!isPlaying) return;

            const trackIndex = Math.floor(Math.random() * 4);
            const gafamInfo = GAFAM[Math.floor(Math.random() * GAFAM.length)];
            
            const noteEl = document.createElement('div');
            noteEl.classList.add('note', gafamInfo.class);
            noteEl.innerText = gafamInfo.char;
            
            // DÃ©part tout en haut
            noteEl.style.top = '-80px';
            
            tracks[trackIndex].appendChild(noteEl);

            notes.push({
                el: noteEl,
                track: trackIndex,
                y: -80,
                active: true,
                type: gafamInfo.char
            });
        }

        function gameLoop() {
            if(!isPlaying) return;

            // DÃ©placement des notes
            notes.forEach(note => {
                if (!note.active) return;

                note.y += NOTE_SPEED;
                note.el.style.top = note.y + 'px';

                // Effet de perspective simple (grossit en descendant)
                // note.el.style.transform = `translateX(-50%) scale(${1 + note.y/1000})`;

                // Note ratÃ©e (sortie de l'Ã©cran)
                if (note.y > 650) {
                    note.active = false;
                    note.el.remove();
                    resetCombo();
                    showFeedback("MISS", note.track, "red");
                }
            });

            // Nettoyage tableau
            notes = notes.filter(n => n.active);

            requestAnimationFrame(gameLoop);
        }

        // --- GESTION DES CLAVIERS ---
        document.addEventListener('keydown', e => {
            if (!isPlaying) return;
            
            const key = e.key;
            if (KEYS.hasOwnProperty(key)) {
                const trackId = KEYS[key];
                pressKey(trackId);
            }
        });

        function pressKey(trackId) {
            // Animation visuelle de la touche
            const zone = tracks[trackId].querySelector('.hit-zone');
            zone.classList.add('pressed');
            setTimeout(() => zone.classList.remove('pressed'), 100);

            // VÃ©rifier si une note est dans la zone
            // On cherche la note ACTIVE la plus proche du bas dans cette piste
            const hitNote = notes.find(n => n.track === trackId && Math.abs(n.y - HIT_Y) < HIT_MARGIN);

            if (hitNote) {
                // SUCCÃˆS !
                hitNote.active = false;
                hitNote.el.remove();
                
                // Calcul prÃ©cision (pour le fun)
                const precision = Math.abs(hitNote.y - HIT_Y);
                let msg = "GOOD";
                if (precision < 15) msg = "PERFECT!!";
                else if (precision < 30) msg = "GREAT!";

                addScore(msg);
                showFeedback(msg, trackId, "#FFD700");
                
                // Effet visuel "Explosion"
                createExplosion(trackId);

            } else {
                // RATÃ‰ (Appui dans le vide)
                resetCombo();
                // showFeedback("BAD", trackId, "red"); // Optionnel, peut Ãªtre frustrant
            }
        }

        function addScore(quality) {
            combo++;
            // Multiplicateur
            if (combo > 40) multiplier = 8;
            else if (combo > 30) multiplier = 4;
            else if (combo > 15) multiplier = 2;
            else multiplier = 1;

            let basePoints = 100;
            if (quality === "PERFECT!!") basePoints = 300;
            else if (quality === "GREAT!") basePoints = 200;

            score += basePoints * multiplier;
            updateUI();
        }

        function resetCombo() {
            combo = 0;
            multiplier = 1;
            updateUI();
            // Flash rouge
            document.body.style.boxShadow = "inset 0 0 50px red";
            setTimeout(() => document.body.style.boxShadow = "none", 100);
        }

        function updateUI() {
            document.getElementById('score').innerText = score.toString().padStart(6, '0');
            document.getElementById('combo').innerText = "COMBO: " + combo;
            document.getElementById('multiplier').innerText = "x" + multiplier;
        }

        function showFeedback(text, trackIndex, color) {
            const track = tracks[trackIndex];
            const el = document.createElement('div');
            el.innerText = text;
            el.classList.add('feedback-text');
            el.style.color = color;
            el.style.bottom = "150px"; // Juste au dessus des touches
            el.style.left = "50%";
            el.style.transform = "translateX(-50%)";
            
            track.appendChild(el);
            setTimeout(() => el.remove(), 500);
        }

        function createExplosion(trackIndex) {
            const track = tracks[trackIndex];
            const boom = document.createElement('div');
            boom.innerText = "ðŸ’¥";
            boom.style.position = "absolute";
            boom.style.bottom = "20px";
            boom.style.left = "50%";
            boom.style.transform = "translateX(-50%)";
            boom.style.fontSize = "60px";
            boom.style.zIndex = "5";
            track.appendChild(boom);
            setTimeout(() => boom.remove(), 200);
        }

        // Allow manual finish: send current score to opener and close
        function sendScoreAndClose() {
            try {
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({ type: 'nird-game-score', level: 3, score: score }, '*');
                }
            } catch (e) {}
            try { window.close(); } catch (e) {}
        }

    </script>
        <!-- Floating finish control -->
        <div style="position:fixed; right:16px; top:16px; z-index:200;">
            <button onclick="sendScoreAndClose()" style="padding:8px 12px; font-size:14px;">Terminer et retourner</button>
        </div>
</body>
</html>