<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Duck Hero: Survival Mode</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap');

        body {
            margin: 0;
            background-color: #111;
            color: white;
            font-family: 'Black Ops One', cursive;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            user-select: none;
        }

        /* --- SCÃˆNE --- */
        #stage {
            position: absolute;
            top: 20px;
            text-align: center;
            z-index: 0;
        }
        #duck-avatar {
            font-size: 100px;
            display: inline-block;
            filter: drop-shadow(0 0 20px #FFD700);
            transition: transform 0.1s;
        }

        /* --- HUD --- */
        #ui {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            z-index: 10;
        }
        #score { font-size: 50px; color: #FFD700; text-shadow: 0 0 10px #FFD700; }
        #combo { font-size: 25px; color: #00e5ff; }
        #multiplier { font-size: 35px; color: #ff0055; margin-top: 5px; }
        
        /* VIES (NOUVEAU) */
        #lives-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            text-align: left;
        }
        #lives-label { font-size: 20px; color: #aaa; }
        #lives-count { font-size: 40px; color: #00ff00; text-shadow: 0 0 10px #00ff00; }
        
        /* Quand il reste peu de vies */
        .danger { color: #ff0000 !important; text-shadow: 0 0 20px #ff0000 !important; animation: pulse 0.5s infinite; }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* INFO VITESSE */
        #speed-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            font-size: 20px;
            color: #aaa;
            z-index: 10;
        }

        /* ALERTE VITESSE */
        #speed-alert {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 80px;
            color: #ff0055;
            text-shadow: 0 0 20px white;
            z-index: 50;
            pointer-events: none;
            transition: transform 0.5s;
        }
        .zoom-effect { transform: translate(-50%, -50%) scale(1) !important; }

        /* --- FRETBOARD --- */
        #fretboard-container { perspective: 600px; margin-top: 100px; }
        #fretboard {
            width: 500px; height: 600px;
            background: linear-gradient(to bottom, #1a1a1a 0%, #000 100%);
            transform: rotateX(50deg);
            border-left: 5px solid #444; border-right: 5px solid #444;
            display: flex; justify-content: space-around; overflow: hidden;
            position: relative; box-shadow: 0 50px 50px rgba(0,0,0,0.8);
        }
        .track { width: 25%; height: 100%; border-right: 2px solid #333; position: relative; }
        .track:last-child { border: none; }

        /* --- TOUCHES --- */
        .hit-zone {
            position: absolute; bottom: 20px; width: 90%; height: 60px; left: 5%;
            border-radius: 10px; border: 4px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.05s, background-color 0.05s, border-color 0.05s;
        }
        .key-label { font-size: 30px; color: rgba(255,255,255,0.5); pointer-events: none; }
        #track-0 .hit-zone { border-color: #00ff00; }
        #track-1 .hit-zone { border-color: #ff0000; }
        #track-2 .hit-zone { border-color: #ffff00; }
        #track-3 .hit-zone { border-color: #0000ff; }
        .pressed { transform: scale(0.95); background-color: rgba(255,255,255,0.8) !important; border-color: white !important; }
        .pressed .key-label { color: black; }

        /* --- NOTES --- */
        .note {
            position: absolute; width: 70px; height: 70px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; border-radius: 50%;
            box-shadow: 0 0 20px currentColor; background: rgba(0,0,0,0.5); border: 2px solid white;
        }
        .note.google { color: #4285F4; box-shadow: 0 0 20px #4285F4; }
        .note.apple  { color: #A2AAAD; box-shadow: 0 0 20px #A2AAAD; }
        .note.meta   { color: #1877F2; box-shadow: 0 0 20px #1877F2; }
        .note.amazon { color: #FF9900; box-shadow: 0 0 20px #FF9900; }
        .note.micro  { color: #00A4EF; box-shadow: 0 0 20px #00A4EF; }

        .feedback-text {
            position: absolute; font-size: 40px; font-weight: bold; color: #fff;
            text-shadow: 0 0 10px #FF0055; animation: floatText 0.5s forwards;
            pointer-events: none; z-index: 20;
        }
        @keyframes floatText {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        /* --- Ã‰CRANS --- */
        #start-screen, #end-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
        }
        #end-screen { display: none; }
        .keys-info { display: flex; gap: 20px; margin: 30px 0; }
        .key-box { border: 2px solid white; padding: 10px 20px; border-radius: 5px; font-size: 24px; color: #FFD700; }
        button {
            padding: 20px 50px; font-size: 30px; background: #FF0055; color: white;
            border: none; font-family: inherit; cursor: pointer;
            box-shadow: 0 0 30px #FF0055; transform: rotate(-2deg); transition: transform 0.1s;
        }
        button:hover { transform: rotate(2deg) scale(1.1); background: white; color: #FF0055; }
        #music-status { margin-top: 10px; font-size: 14px; color: #aaa; }

    </style>
</head>
<body>

    <audio id="bg-music" src="canard.mp3" preload="auto"></audio>

    <div id="start-screen">
        <h1 style="font-size: 70px; color: #FFD700; margin: 0;">DUCK HERO</h1>
        <h2 style="color: white;">SURVIVAL MODE</h2>
        <p style="color: #aaa; margin-top: 20px;">Place tes doigts sur :</p>
        <div class="keys-info">
            <div class="key-box" style="border-color: #00ff00;">D</div>
            <div class="key-box" style="border-color: #ff0000;">F</div>
            <div class="key-box" style="border-color: #ffff00;">J</div>
            <div class="key-box" style="border-color: #0000ff;">K</div>
        </div>
        <p style="color: red; margin-bottom: 20px;">10 ERREURS MAX !</p>
        <button onclick="startGame()">JOUER ! ðŸ¤˜</button>
        <div id="music-status">VÃ©rifiez que 'canard.mp3' est prÃ©sent</div>
    </div>

    <div id="end-screen">
        <h1 style="font-size: 70px; color: red; margin: 0;">GAME OVER</h1>
        <h2>Score Final : <span id="final-score">0</span></h2>
        <button onclick="location.reload()">REJOUER â†»</button>
        <button onclick="sendScoreAndClose()">Retour Ã  la map</button>
    </div>

    <div id="ui">
        <div id="score">00000</div>
        <div id="combo">COMBO: 0</div>
        <div id="multiplier">x1</div>
    </div>
    
    <div id="lives-container">
        <div id="lives-label">VIES RESTANTES</div>
        <div id="lives-count">10</div>
    </div>

    <div id="speed-info">VITESSE: 100%</div>
    <div id="speed-alert">SPEED UP!!!</div>

    <div id="stage">
        <div id="duck-avatar">ðŸ¦†ðŸŽ¸</div>
    </div>

    <div id="fretboard-container">
        <div id="fretboard">
            <div class="track" id="track-0"><div class="hit-zone"><span class="key-label">D</span></div></div>
            <div class="track" id="track-1"><div class="hit-zone"><span class="key-label">F</span></div></div>
            <div class="track" id="track-2"><div class="hit-zone"><span class="key-label">J</span></div></div>
            <div class="track" id="track-3"><div class="hit-zone"><span class="key-label">K</span></div></div>
        </div>
    </div>

    <script>
        const KEYS = { 'd': 0, 'D': 0, 'f': 1, 'F': 1, 'j': 2, 'J': 2, 'k': 3, 'K': 3 };
        const GAFAM = [
            { char: "G", class: "google" }, { char: "ðŸŽ", class: "apple" },
            { char: "ðŸ“˜", class: "meta" }, { char: "ðŸ“¦", class: "amazon" }, { char: "ðŸªŸ", class: "micro" }
        ];

        const tracks = [
            document.getElementById('track-0'), document.getElementById('track-1'),
            document.getElementById('track-2'), document.getElementById('track-3')
        ];

        // --- PARAMÃˆTRES ---
        const BPM = 140; 
        const MAX_LIVES = 10;
        let lives = MAX_LIVES;
        let currentSpeedFactor = 1.0; 
        let BASE_NOTE_SPEED = 6;
        let noteSpeed = BASE_NOTE_SPEED;
        
        const HIT_Y = 530;
        const HIT_MARGIN = 60;

        let notes = [];
        let score = 0;
        let combo = 0;
        let multiplier = 1;
        let isPlaying = false;
        let spawner;
        
        const music = document.getElementById('bg-music');
        const statusText = document.getElementById('music-status');
        const duck = document.getElementById('duck-avatar');
        const livesEl = document.getElementById('lives-count');

        music.addEventListener('error', (e) => {
            statusText.innerText = "Erreur: Fichier 'canard.mp3' introuvable !";
            statusText.style.color = "red";
        });

        // --- GESTION MUSIQUE ET VITESSE ---
        music.addEventListener('ended', () => {
            accelerateGame();
        });

        function accelerateGame() {
            currentSpeedFactor += 0.3;
            music.playbackRate = currentSpeedFactor;
            music.currentTime = 0;
            music.play();

            noteSpeed = BASE_NOTE_SPEED * currentSpeedFactor;

            clearInterval(spawner);
            let newInterval = (60000 / BPM) / currentSpeedFactor; 
            spawner = setInterval(spawnNote, newInterval);

            document.getElementById('speed-info').innerText = "VITESSE: " + Math.round(currentSpeedFactor * 100) + "%";
            document.getElementById('speed-info').style.color = "#ff0055";

            const alertBox = document.getElementById('speed-alert');
            alertBox.classList.add('zoom-effect');
            setTimeout(() => alertBox.classList.remove('zoom-effect'), 1500);
        }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            
            music.volume = 1.0; 
            music.play().catch(e => {
                alert("Impossible de lire canard.mp3 !");
            });

            isPlaying = true;
            lives = MAX_LIVES;
            updateLivesUI();
            
            gameLoop();
            
            let interval = (60000 / BPM); 
            spawner = setInterval(spawnNote, interval);
            
            // Headbang synchro
            setInterval(() => {
                if(isPlaying) {
                    duck.style.transform = "rotate(15deg) translateY(20px)";
                    setTimeout(() => duck.style.transform = "rotate(-15deg) translateY(0)", (300 / currentSpeedFactor));
                }
            }, (60000/BPM) / currentSpeedFactor);
        }

        function spawnNote() {
            if(!isPlaying) return;
            const trackIndex = Math.floor(Math.random() * 4);
            const gafamInfo = GAFAM[Math.floor(Math.random() * GAFAM.length)];
            
            const noteEl = document.createElement('div');
            noteEl.classList.add('note', gafamInfo.class);
            noteEl.innerText = gafamInfo.char;
            noteEl.style.top = '-80px';
            tracks[trackIndex].appendChild(noteEl);

            notes.push({
                el: noteEl, track: trackIndex, y: -80, active: true, type: gafamInfo.char
            });
        }

        function gameLoop() {
            if(!isPlaying) return;

            notes.forEach(note => {
                if (!note.active) return;
                
                note.y += noteSpeed;
                note.el.style.top = note.y + 'px';

                // --- GESTION DES NOTES RATÃ‰ES ---
                if (note.y > 650) {
                    note.active = false;
                    note.el.remove();
                    
                    resetCombo();
                    showFeedback("MISS", note.track, "red");
                    
                    // PERTE DE VIE
                    lives--;
                    updateLivesUI();
                    
                    if (lives <= 0) {
                        endGame();
                    }
                }
            });

            notes = notes.filter(n => n.active);
            requestAnimationFrame(gameLoop);
        }

        function updateLivesUI() {
            livesEl.innerText = lives;
            if (lives <= 3) {
                livesEl.classList.add('danger');
                livesEl.style.color = 'red';
            } else {
                livesEl.classList.remove('danger');
                livesEl.style.color = '#00ff00';
            }
        }

        function endGame() {
            isPlaying = false;
            clearInterval(spawner);
            music.pause();
            document.getElementById('final-score').innerText = score;
            document.getElementById('end-screen').style.display = 'flex';
        }

        document.addEventListener('keydown', e => {
            if (!isPlaying) return;
            const key = e.key;
            if (KEYS.hasOwnProperty(key)) {
                pressKey(KEYS[key]);
            }
        });

        function pressKey(trackId) {
            const zone = tracks[trackId].querySelector('.hit-zone');
            zone.classList.add('pressed');
            setTimeout(() => zone.classList.remove('pressed'), 100);

            const hitNote = notes.find(n => n.track === trackId && Math.abs(n.y - HIT_Y) < HIT_MARGIN);

            if (hitNote) {
                hitNote.active = false;
                hitNote.el.remove();
                
                const precision = Math.abs(hitNote.y - HIT_Y);
                let msg = "GOOD";
                if (precision < 15) msg = "PERFECT!!";
                else if (precision < 30) msg = "GREAT!";

                addScore(msg);
                showFeedback(msg, trackId, "#FFD700");
            } else {
                resetCombo();
            }
        }

        function addScore(quality) {
            combo++;
            if (combo > 40) multiplier = 8;
            else if (combo > 30) multiplier = 4;
            else if (combo > 15) multiplier = 2;
            else multiplier = 1;

            let basePoints = 100;
            if (quality === "PERFECT!!") basePoints = 300;
            else if (quality === "GREAT!") basePoints = 200;

            score += Math.floor(basePoints * multiplier * currentSpeedFactor);
            updateUI();
        }

        function resetCombo() {
            combo = 0;
            multiplier = 1;
            updateUI();
            document.body.style.boxShadow = "inset 0 0 50px red";
            setTimeout(() => document.body.style.boxShadow = "none", 100);
        }

        function updateUI() {
            document.getElementById('score').innerText = score.toString().padStart(6, '0');
            document.getElementById('combo').innerText = "COMBO: " + combo;
            document.getElementById('multiplier').innerText = "x" + multiplier;
        }

        function showFeedback(text, trackIndex, color) {
            const track = tracks[trackIndex];
            const el = document.createElement('div');
            el.innerText = text;
            el.classList.add('feedback-text');
            el.style.color = color;
            el.style.bottom = "150px"; 
            el.style.left = "50%";
            el.style.transform = "translateX(-50%)";
            track.appendChild(el);
            setTimeout(() => el.remove(), 500);
        }

        function createExplosion(trackIndex) {
            const track = tracks[trackIndex];
            const boom = document.createElement('div');
            boom.innerText = "ðŸ’¥";
            boom.style.position = "absolute";
            boom.style.bottom = "20px";
            boom.style.left = "50%";
            boom.style.transform = "translateX(-50%)";
            boom.style.fontSize = "60px";
            boom.style.zIndex = "5";
            track.appendChild(boom);
            setTimeout(() => boom.remove(), 200);
        }

        // Allow manual finish: send current score to opener and close
        function sendScoreAndClose() {
            try {
                const url = `/map?level=3&score=${encodeURIComponent(score)}`;
                window.location.href = url;
            } catch (e) {}
        }


        let saisie = "";
        document.addEventListener('keydown', (e) => {
            saisie += e.key.toLowerCase();
            // Easter egg : si on tape "snake", on est redirigÃ©
            if (!"snake".startsWith(saisie)) saisie = e.key === 's' ? 's' : '';
            if (saisie === "snake") window.location.href = "snake.html";

            if (!"bouton".startsWith(saisie)) saisie = e.key === 'b' ? 'b' : '';
            if (saisie === "bouton") window.location.href = "boutonCssFou.html";
        });

        

    </script>
</body>
</html>